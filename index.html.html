<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Australian Steel Design Assistant ‚Äî Pro Edition</title>
  <style>
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #95a5a6;
      --secondary-dark: #7f8c8d;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #2c3e50;
      --text-light: #7f8c8d;
      --border-color: #e0e0e0;
      --border-radius: 10px;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light-bg); color: var(--text-color); margin: 0; padding: 20px;
    }
    .app-container { max-width: 1300px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff; padding: 24px; border-radius: var(--border-radius);
      position: relative; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 20px;
    }
    .theme-toggle { position:absolute; right:14px; top:14px; background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px; }
    .steps { display:flex; gap:8px; align-items:center; justify-content:center; margin:12px 0 18px; flex-wrap:wrap; }
    .step-circle { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; background:#d7dde3; color:#fff; }
    .step-circle.active { background: var(--primary-color); }
    .step-circle.done { background: var(--success-color); }
    .step-line { width:48px; height:4px; background:#d7dde3; border-radius:4px; }
    .form-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; }
    label { font-weight:600; margin-bottom:6px; display:block; }
    input[type="number"], input[type="text"], select, textarea {
      width:100%; padding:10px; border:1px solid var(--border-color); border-radius:8px; background:#fff;
    }
    textarea { min-height:100px; }
    .btn { background: var(--primary-color); color:#fff; border:none; border-radius:8px; padding:10px 16px; font-weight:600; cursor:pointer; }
    .btn.secondary { background: var(--secondary-color); }
    .btn.danger { background: var(--danger-color); }
    .btn:disabled { background:#b9c3cc; cursor:not-allowed; }
    .button-bar { display:flex; gap:10px; justify-content:space-between; margin-top:12px; }
    .hidden { display:none !important; }
    .result-table { width:100%; border-collapse: collapse; }
    .result-table th, .result-table td { padding:10px; border-bottom:1px solid var(--border-color); text-align:left; }
    .result-table th { background: #eef6fe; }
    .status { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .status-ok { background: rgba(46, 204, 113, .15); color:#22b36a; }
    .status-warn { background: rgba(243, 156, 18, .15); color:#c27900; }
    .status-bad { background: rgba(231, 76, 60, .15); color:#cf4538; }
    .notification {
      position: fixed; left:50%; transform: translateX(-50%);
      bottom: 18px; background: #2d3035; color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s ease;
    }
    .notification.show { opacity:1; pointer-events:auto; }
    .member-list { width:100%; border-collapse: collapse; margin-top:10px; }
    .member-list th, .member-list td { border-bottom:1px solid var(--border-color); padding:6px; font-size:14px; }
    .inline { display:flex; gap:8px; align-items:center; }
    .tight { padding:6px 10px; border-radius:6px; font-size:14px; }
    .muted { color: var(--text-light); font-size: 12px; }
    /* dark mode */
    .dark-mode body, body.dark-mode { background:#1f2227; color:#e5e5e5; }
    body.dark-mode .card { background:#2a2e34; }
    body.dark-mode .result-table th { background:#233142; }
    body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode textarea { background:#343941; color:#e5e5e5; border-color:#4a4d52; }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="header">
      <button class="theme-toggle" aria-label="Toggle dark mode" id="theme-toggle">üåô</button>
      <h1>Australian Steel Design Assistant (Pro Edition)</h1>
      <p>Multi-member checks, callouts, title block, and AS 4100-style capacity checks</p>
    </div>

    <div class="steps">
      <div class="step-circle" id="s1">1</div><div class="step-line"></div>
      <div class="step-circle" id="s2">2</div><div class="step-line"></div>
      <div class="step-circle" id="s3">3</div><div class="step-line"></div>
      <div class="step-circle" id="s4">4</div><div class="step-line"></div>
      <div class="step-circle" id="s5">5</div>
    </div>

    <!-- Step 1: choose design type -->
    <div class="card" id="step1">
      <h2>Step 1 ‚Äî Design type</h2>
      <div class="form-row">
        <div>
          <label for="design-type">Type</label>
          <select id="design-type">
            <option value="">Select‚Ä¶</option>
            <option value="single">Single Member</option>
            <option value="multi">Multiple Members</option>
            <option value="connection">Connection Design</option>
          </select>
        </div>
      </div>
      <div class="button-bar">
        <button class="btn secondary" id="prev1" disabled>Back</button>
        <button class="btn" id="next1" disabled>Next</button>
      </div>
    </div>

    <!-- Step 2: member specs -->
    <div class="card hidden" id="step2">
      <h2>Step 2 ‚Äî Member specification</h2>

      <!-- Single-member UI -->
      <div id="single-ui">
        <div class="form-row">
          <div>
            <label for="member-type">Member</label>
            <select id="member-type">
              <option value="beam">Beam</option>
              <option value="column">Column</option>
            </select>
          </div>
          <div>
            <label for="section-type">Section Type</label>
            <select id="section-type">
              <option value="ub">Universal Beam (UB)</option>
              <option value="uc">Universal Column (UC)</option>
              <option value="rhs">RHS</option>
            </select>
          </div>
          <div>
            <label for="section-size">Section Size</label>
            <select id="section-size"></select>
          </div>
          <div>
            <label for="member-length">Member Length (mm)</label>
            <input type="number" id="member-length" value="4000" min="100"/>
          </div>
          <div>
            <label for="steel-grade">Steel Grade</label>
            <select id="steel-grade">
              <option value="300">Grade 300</option>
              <option value="350" selected>Grade 350</option>
            </select>
          </div>
        </div>
        <div id="section-details" class="card" style="margin-top:10px;"></div>
      </div>

      <!-- Multi-member UI -->
      <div id="multi-ui" class="hidden">
        <div class="form-row">
          <div>
            <label for="multi-steel-grade">Steel Grade (all)</label>
            <select id="multi-steel-grade">
              <option value="300">Grade 300</option>
              <option value="350" selected>Grade 350</option>
            </select>
          </div>
          <div>
            <label for="member-spacing">Member Spacing (mm)</label>
            <input type="number" id="member-spacing" value="3000" min="1"/>
          </div>
          <div>
            <label for="row-origin">Row Origin (X=0 mm)</label>
            <input type="number" id="row-origin" value="0" />
          </div>
        </div>

        <div class="inline" style="justify-content: space-between; margin-top: 6px;">
          <div class="inline">
            <button class="btn tight" id="add-member">+ Add member</button>
            <button class="btn secondary tight" id="clear-members">Clear</button>
          </div>
          <div class="muted">Tip: Use IDs for shop drawing labels.</div>
        </div>

        <table class="member-list" id="member-table" aria-label="Member list">
          <thead>
            <tr>
              <th>ID</th><th>Type</th><th>Section</th><th>Size</th>
              <th>Length</th><th>Index</th><th>Lb (mm)</th><th>kL (mm)</th>
              <th>A-end</th><th>B-end</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="member-tbody"></tbody>
        </table>
      </div>

      <!-- Connection UI (Shear Plate MVP) -->
      <div id="conn-ui" class="hidden">
        <div class="form-row">
          <div>
            <label for="conn-section-type">Member Section</label>
            <select id="conn-section-type">
              <option value="ub">Universal Beam (UB)</option>
              <option value="uc">Universal Column (UC)</option>
            </select>
          </div>
          <div>
            <label for="conn-section-size">Section Size</label>
            <select id="conn-section-size"></select>
          </div>
          <div>
            <label for="conn-steel-grade">Steel Grade</label>
            <select id="conn-steel-grade">
              <option value="300">Grade 300</option>
              <option value="350" selected>Grade 350</option>
            </select>
          </div>
        </div>
        <div class="card" style="margin-top:10px;">
          <h3>Shear Plate Parameters</h3>
          <div class="form-row">
            <div>
              <label for="conn-bolt-dia">Bolt Diameter</label>
              <select id="conn-bolt-dia">
                <option value="12">M12</option>
                <option value="16" selected>M16</option>
                <option value="20">M20</option>
                <option value="24">M24</option>
              </select>
            </div>
            <div>
              <label for="conn-bolt-class">Bolt Class</label>
              <select id="conn-bolt-class">
                <option value="8.8" selected>8.8</option>
                <option value="10.9">10.9</option>
              </select>
            </div>
            <div>
              <label for="conn-rows">Bolt Rows (vertical)</label>
              <input type="number" id="conn-rows" value="2" min="1" />
            </div>
            <div>
              <label for="conn-pitch">Pitch p (mm)</label>
              <input type="number" id="conn-pitch" value="70" min="40" />
            </div>
            <div>
              <label for="conn-e1">Edge distance e1 (mm)</label>
              <input type="number" id="conn-e1" value="35" min="20" />
            </div>
            <div>
              <label for="conn-e2">End distance e2 (mm)</label>
              <input type="number" id="conn-e2" value="35" min="20" />
            </div>
            <div>
              <label for="conn-plate-t">Plate thickness t (mm)</label>
              <input type="number" id="conn-plate-t" value="10" min="6" />
            </div>
            <div>
              <label for="conn-weld-a">Fillet weld size a (mm)</label>
              <input type="number" id="conn-weld-a" value="6" min="4" />
            </div>
          </div>
          <div class="muted">Note: Prototype only ‚Äî capacities indicative; calibrate to AS 4100:2020.</div>
        </div>
      </div>

      <div class="button-bar">
        <button class="btn secondary" id="prev2">Back</button>
        <button class="btn" id="next2">Next</button>
      </div>
    </div>

    <!-- Step 3: loading -->
    <div class="card hidden" id="step3">
      <h2>Step 3 ‚Äî Loading</h2>
      <div id="single-loads">
        <div class="form-row">
          <div>
            <label for="load-type">Load Type</label>
            <select id="load-type">
              <option value="uniform" selected>Uniform (total kN)</option>
              <option value="point">Point (kN @ midspan)</option>
            </select>
          </div>
          <div>
            <label for="dead-load">Dead Load G (kN)</label>
            <input type="number" id="dead-load" value="5" min="0" step="0.1"/>
          </div>
          <div>
            <label for="live-load">Live Load Q (kN)</label>
            <input type="number" id="live-load" value="10" min="0" step="0.1"/>
          </div>
          <div>
            <label for="axial-load">Axial N* (kN)</label>
            <input type="number" id="axial-load" value="0" step="0.1"/>
          </div>
        </div>
      </div>

      <div id="multi-loads" class="hidden">
        <div class="form-row">
          <div>
            <label for="multi-load-type">Load Type (all)</label>
            <select id="multi-load-type">
              <option value="uniform" selected>Uniform (total kN)</option>
              <option value="point">Point (kN @ midspan)</option>
            </select>
          </div>
          <div>
            <label for="multi-dead-load">Dead Load G per member (kN)</label>
            <input type="number" id="multi-dead-load" value="5" min="0" step="0.1"/>
          </div>
          <div>
            <label for="multi-live-load">Live Load Q per member (kN)</label>
            <input type="number" id="multi-live-load" value="10" min="0" step="0.1"/>
          </div>
          <div>
            <label for="multi-axial-load">Axial N* per member (kN)</label>
            <input type="number" id="multi-axial-load" value="0" step="0.1"/>
          </div>
        </div>
      </div>

      <!-- Connection Loads -->
      <div id="conn-loads" class="hidden">
        <div class="form-row">
          <div>
            <label for="conn-V">Shear V* (kN)</label>
            <input type="number" id="conn-V" value="100" min="0" step="0.1" />
          </div>
          <div>
            <label for="conn-N">Axial N* (kN)</label>
            <input type="number" id="conn-N" value="0" step="0.1" />
          </div>
          <div>
            <label for="conn-M">Moment M* (kNm)</label>
            <input type="number" id="conn-M" value="0" step="0.1" />
          </div>
        </div>
      </div>

      <div class="button-bar">
        <button class="btn secondary" id="prev3">Back</button>
        <button class="btn" id="next3">Calculate</button>
      </div>
    </div>

    <!-- Step 4: results -->
    <div class="card hidden" id="step4">
      <h2>Step 4 ‚Äî Results & Shop Drawing</h2>
      <div class="form-row">
        <div>
          <label for="result-view-selector">View</label>
          <select id="result-view-selector">
            <option value="summary">Summary</option>
            <option value="detailed">Detailed</option>
            <option value="drawing">Shop Drawing</option>
          </select>
        </div>
      </div>

      <div id="result-summary" class="card" style="margin-top:12px;">
        <h3>Member checks</h3>
        <div id="summary-container"></div>
      </div>

      <div id="result-detailed" class="card hidden" style="margin-top:12px;">
        <h3>Detailed visual</h3>
        <canvas id="detailed-analysis" width="1100" height="300" style="width:100%; border:1px solid var(--border-color); border-radius:8px;"></canvas>
        <ul id="analysis-notes"></ul>
      </div>

      <div id="result-drawing" class="card hidden" style="margin-top:12px;">
        <h3>Shop Drawing ‚Äî Plan & Elevation</h3>
        <canvas id="shop-drawing" width="1200" height="600" style="width:100%; border:1px solid var(--border-color); border-radius:8px; background:#fff;"></canvas>

        <div class="form-row" style="margin-top:8px;">
          <div>
            <label><input type="checkbox" id="toggle-callouts" checked/> Show Callouts</label>
            <label><input type="checkbox" id="toggle-dims" checked/> Show Dimensions</label>
            <label><input type="checkbox" id="toggle-elev" checked/> Show Elevation</label>
            <label><input type="checkbox" id="toggle-instructions"/> Overlay Instructions</label>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4>Title Block Editor</h4>
          <div class="form-row">
            <div><label>Project</label><input type="text" id="tb-project" value="My Project"/></div>
            <div><label>Drawing Title</label><input type="text" id="tb-title" value="Steel Frame"/></div>
            <div><label>Drawing No.</label><input type="text" id="tb-dwgno" value="S-001"/></div>
          </div>
          <div class="form-row">
            <div><label>Revision</label><input type="text" id="tb-rev" value="A"/></div>
            <div><label>Drawn By</label><input type="text" id="tb-drawn" value=""/></div>
            <div><label>Checked By</label><input type="text" id="tb-checked" value=""/></div>
          </div>
          <div class="form-row">
            <div><label>Date</label><input type="text" id="tb-date" value=""></div>
            <div><label>Scale</label><input type="text" id="tb-scale" value="Auto-fit"></div>
          </div>
          <button class="btn secondary" id="redraw">Redraw</button>
        </div>

        <div class="inline" style="margin-top:8px; justify-content: space-between;">
          <div class="muted">Drawing auto-fits to canvas. Use title block editor above.</div>
          <div class="inline">
            <button class="btn secondary tight" id="download-png">Download PNG</button>
          </div>
        </div>
      </div>

      <div class="button-bar">
        <button class="btn secondary" id="prev4">Back</button>
        <button class="btn" id="download">Download JSON</button>
      </div>
    </div>

    <!-- Step 5: Assembly Instructions -->
    <div class="card hidden" id="step5">
      <h2>Step 5 ‚Äî Assembly Instructions</h2>

      <div id="single-instr" class="hidden">
        <label for="single-instructions">Procedure</label>
        <textarea id="single-instructions" placeholder="Enter instructions for constructing the member..."></textarea>
      </div>

      <div id="multi-instr" class="hidden">
        <div>
          <label for="general-instructions">General Procedure / Notes</label>
          <textarea id="general-instructions" placeholder="General assembly procedure for the frame..."></textarea>
        </div>
        <div id="per-member-instr"></div>
      </div>

      <div class="button-bar">
        <button class="btn secondary" id="prev5">Back</button>
        <button class="btn" id="finish">Finish</button>
        <button class="btn secondary" id="download-instr">Download TXT</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification"><span id="notification-text"></span></div>

  <script>
  // ===============================
  // Constants & Section Catalogue
  // ===============================
  const CONSTANTS = {
    PHI: { MOMENT: 0.9, SHEAR: 0.9, AXIAL: 0.9 },
    STEEL_GRADE: {
      "300": { fy: 300, fu: 440, E: 200e3 },   // MPa
      "350": { fy: 350, fu: 480, E: 200e3 }    // MPa
    },
    G: 9.81, // not currently used but kept for future
  };

  // Standards metadata (prototype values; clause keys are placeholders)
  const AS4100 = {
    version: '2020',
    phi: { boltShear: 0.8, bearing: 0.8, weld: 0.8 },
    clause: {
      boltShear: 'AS4100-2020 Cl. 9.x (placeholder)',
      bearing: 'AS4100-2020 Cl. 9.y (placeholder)',
      weld: 'AS4100-2020 Cl. 9.z (placeholder)'
    }
  };

  // Expanded offline catalogue (illustrative subset)
  // Ix, Iy in mm^4; Zx, Zy in mm^3; mass kg/m; dims in mm
  const sectionDatabase = {
    ub: [
      { size:"UB 200x25", mass:25.4, depth:200, width:100, tf:7, tw:5, Ix: 1.68e8, Iy: 5.88e7, Zx: 1.68e8/(200/2), Zy: 5.88e7/(100/2) },
      { size:"UB 250x31", mass:31.4, depth:255, width:146, tf:8, tw:6, Ix: 3.20e8, Iy: 1.05e8, Zx: 3.20e8/(255/2), Zy: 1.05e8/(146/2) },
      { size:"UB 310x40", mass:40.4, depth:310, width:125, tf:9, tw:6, Ix: 5.10e8, Iy: 1.78e8, Zx: 5.10e8/(310/2), Zy: 1.78e8/(125/2) },
      { size:"UB 360x51", mass:51.0, depth:360, width:134, tf:11, tw:7, Ix: 8.80e8, Iy: 2.55e8, Zx: 8.80e8/(360/2), Zy: 2.55e8/(134/2) }
    ],
    uc: [
      { size:"UC 150x37", mass:37.0, depth:152, width:152, tf:9, tw:6, Ix: 1.75e8, Iy: 1.75e8, Zx: 1.75e8/(152/2), Zy: 1.75e8/(152/2) },
      { size:"UC 200x46", mass:46.1, depth:200, width:200, tf:11, tw:7, Ix: 3.80e8, Iy: 3.80e8, Zx: 3.80e8/(200/2), Zy: 3.80e8/(200/2) },
      { size:"UC 250x73", mass:73.0, depth:255, width:255, tf:14, tw:9, Ix: 1.05e9, Iy: 1.05e9, Zx: 1.05e9/(255/2), Zy: 1.05e9/(255/2) }
    ],
    rhs: [
      { size:"RHS 150x100x6", mass:26.0, depth:150, width:100, thickness:6, Ix: 1.40e8, Iy: 7.8e7, Zx: 1.40e8/(150/2), Zy: 7.8e7/(100/2) },
      { size:"RHS 200x100x6", mass:30.5, depth:200, width:100, thickness:6, Ix: 2.55e8, Iy: 9.5e7, Zx: 2.55e8/(200/2), Zy: 9.5e7/(100/2) },
      { size:"RHS 200x150x6", mass:36.2, depth:200, width:150, thickness:6, Ix: 3.85e8, Iy: 2.10e8, Zx: 3.85e8/(200/2), Zy: 2.10e8/(150/2) }
    ]
  };

  // ===============================
  // State
  // ===============================
  let currentStep = 1;
  let designType = null;

  // Single-mode inputs
  const single = { sectionData: null, loadingData: null, axial: 0, instructions: "" };

  // Multi-mode inputs
  const multi = {
    members: [], // {id, memberType, sectionType, sectionSize, length, index, Lb, kL, endA, endB, section}
    steelGrade: "350",
    spacing: 3000,
    origin: 0,
    loading: { loadType:"uniform", dead:5, live:10, axial:0 },
    instructions: { general:"", perMember: {} } // perMember keyed by id
  };

  // Connection mode inputs (Shear Plate MVP)
  const conn = {
    member: { sectionType: 'ub', sectionSize: '', steelGrade: '350', section: null },
    bolts: { dia: 16, cls: '8.8', rows: 2 },
    geom: { pitch: 70, e1: 35, e2: 35, t: 10 },
    weld: { a: 6 },
    loads: { V: 100, N: 0, M: 0 }
  };

  // Title block state
  const titleBlock = {
    project: "My Project",
    title: "Steel Frame",
    number: "S-001",
    rev: "A",
    drawn: "",
    checked: "",
    date: "",
    scale: "Auto-fit"
  };

  // ===============================
  // Utilities
  // ===============================
  function showNotification(msg) {
    const n = document.getElementById('notification');
    const t = document.getElementById('notification-text');
    t.textContent = msg;
    n.classList.add('show');
    setTimeout(()=> n.classList.remove('show'), 2200);
  }
  function fmt(v, units="") {
    if (typeof v !== "number" || !isFinite(v)) return "‚Äî";
    return v.toFixed(2) + (units? " "+units: "");
  }
  function formatDims(section){
    if (!section) return "‚Äî";
    if (section.depth && section.width && section.thickness)
      return `${section.depth}√ó${section.width}√ó${section.thickness} mm`;
    if (section.depth && section.width) return `${section.depth}√ó${section.width} mm`;
    return "‚Äî";
  }
  function getStatusClass(ratio){
    if (!isFinite(ratio)) return "status-bad";
    if (ratio <= 0.9) return "status-ok";
    if (ratio <= 1.0) return "status-warn";
    return "status-bad";
  }
  function findSection(type, size){
    const list = sectionDatabase[type] || [];
    return list.find(s => s.size === size) || null;
  }
  function safeNum(v, d=0){ const n = parseFloat(v); return isFinite(n) ? n : d; }

  // ===============================
  // Connection Engine ‚Äî Shear Plate (prototype)
  // ===============================
  const boltShearTable = {
    '8.8': { 12: 30, 16: 55, 20: 85, 24: 125 }, // kN per bolt, single shear
    '10.9': { 12: 40, 16: 70, 20: 110, 24: 160 }
  };
  function boltShearCapacity_kN(dia, cls){
    const row = boltShearTable[cls] || boltShearTable['8.8'];
    return row[dia] || 0;
  }
  function kbFactor_EuroLike(d, e1, p){
    const v1 = e1/(3*d);
    const v2 = Math.max(0, (p/(3*d) - 0.25));
    return Math.max(0.5, Math.min(2.5, Math.min(v1, v2)));
  }
  function plateBearingCapacityPerBolt_kN(plateGrade, t, d, e1, p){
    const fu = CONSTANTS.STEEL_GRADE[plateGrade].fu;
    const kb = kbFactor_EuroLike(d, e1, p);
    const capN = AS4100.phi.bearing * kb * d * t * fu; // N
    return capN / 1000; // kN
  }
  function memberBearingCapacityPerBolt_kN(memberGrade, t_web, d, e1, p){
    const fu = CONSTANTS.STEEL_GRADE[memberGrade].fu;
    const kb = kbFactor_EuroLike(d, e1, p);
    const capN = AS4100.phi.bearing * kb * d * t_web * fu; // N
    return capN / 1000; // kN
  }
  function weldShearCapacity_kN_per_mm(a){
    const throat = 0.7 * a; // mm
    const fu = 410; // MPa placeholder
    const capN = AS4100.phi.weld * 0.6 * fu * throat; // N/mm
    return capN / 1000; // kN/mm
  }
  function designShearPlate(conn){
    const { member, bolts, geom, weld, loads } = conn;
    const rows = Math.max(1, Math.floor(bolts.rows));
    const cols = 1;
    const nbolts = rows * cols;
    const V = Math.max(0, loads.V||0);
    const perBoltDem = V / Math.max(1, nbolts);
    const boltCap = boltShearCapacity_kN(bolts.dia, bolts.cls);
    const plateBear = plateBearingCapacityPerBolt_kN(member.steelGrade, geom.t, bolts.dia, geom.e1, geom.pitch);
    const webThk = (member.section && (member.section.tw || member.section.thickness)) || 6;
    const memBear = memberBearingCapacityPerBolt_kN(member.steelGrade, webThk, bolts.dia, geom.e1, geom.pitch);
    // Weld length estimate: single line along plate height
    const plateHeight = 2*geom.e2 + (rows>1? (rows-1)*geom.pitch : 0);
    const weldLenEach = plateHeight;
    const weldCap = weldShearCapacity_kN_per_mm(weld.a) * weldLenEach; // kN
    const checks = [];
    function pushCheck(name, clauseRef, demand, capacity){
      const utilisation = capacity>0 ? demand/capacity : Infinity;
      checks.push({ name, clauseRef, demand, capacity, utilisation });
    }
    pushCheck('Bolt shear (per bolt)', AS4100.clause.boltShear, perBoltDem, boltCap);
    pushCheck('Plate bearing (per bolt)', AS4100.clause.bearing, perBoltDem, plateBear);
    pushCheck('Member bearing (per bolt)', AS4100.clause.bearing, perBoltDem, memBear);
    pushCheck('Weld shear (total, 1 side)', AS4100.clause.weld, V, weldCap);
    let gov = checks[0];
    checks.forEach(c => { if (c.utilisation > gov.utilisation) gov = c; });
    const ok = gov.utilisation <= 1.0;
    const bom = { plates: 1, bolts: nbolts, washers: nbolts, nuts: nbolts, weld_length_mm: Math.round(weldLenEach) };
    const notes = [];
    if (geom.e1 < 1.2*bolts.dia) notes.push('Edge distance e1 may be below typical minimum.');
    if (geom.pitch < 2.5*bolts.dia) notes.push('Pitch may be below typical minimum.');
    notes.push('Prototype calculation ‚Äî verify per AS4100:2020.');
    return { inputsEcho: JSON.parse(JSON.stringify(conn)), checks, governingCheck: gov.name, ok, bom, notes };
  }

    // ===============================
  // Engineering Calculations (AS 4100-inspired, simplified)
  // ===============================

  function elasticSectionModulus(section, axis='x'){
    return axis==='x' ? (section.Zx||0) : (section.Zy||0);
    // Units: mm^3
  }

  function momentCapacityNoBuckling(section, steelGrade, axis='x'){
    const Z = elasticSectionModulus(section, axis);
    const fy = CONSTANTS.STEEL_GRADE[steelGrade].fy; // MPa
    const Ms = Z * fy / 1e6; // kNm
    return CONSTANTS.PHI.MOMENT * Ms;
  }

  // Heuristic LTB reduction based on unbraced length Lb (mm) and approx radius of gyration about minor axis
  function momentCapacityWithLTB(section, steelGrade, Lb_mm){
    if (!Lb_mm || Lb_mm<=0) return momentCapacityNoBuckling(section, steelGrade, 'x');
    const base = momentCapacityNoBuckling(section, steelGrade, 'x');

    // crude r_y estimate
    const Iy = section.Iy || (section.Ix*0.35) || 0;
    const A_approx = (section.mass||0) * 1e6 / 7850 / 1000; // m -> mm^2 (very rough)
    const ry = (Iy>0 && A_approx>0) ? Math.sqrt(Iy / A_approx) : 15; // mm
    const slender = Lb_mm / Math.max(ry, 1);

    // Reduction: > 120 slender => strong reduction
    let red = 1.0;
    if (slender > 120) red = Math.max(0.35, 1 - (slender-120)/400); // cap floor
    else if (slender > 80) red = 1 - (slender-80)/200;
    return Math.max(0.3, base * red);
  }

  function shearCapacity(section, steelGrade, axis='x'){
    let Av = 0;
    if (section.tw && section.depth){ // I-section approx
      Av = (axis==='x') ? section.depth * section.tw : 2*section.width*section.tf;
    } else if (section.thickness && section.depth && section.width){ // RHS
      Av = (axis==='x') ? 2*section.depth*section.thickness : 2*section.width*section.thickness;
    }
    const fy = CONSTANTS.STEEL_GRADE[steelGrade].fy;
    const Vw = 0.6 * fy * Av / 1000; // kN
    return CONSTANTS.PHI.SHEAR * Vw;
  }

  function deflectionSimplySupported(section, steelGrade, L_mm, totalLoad_kN, loadType){
    const E = CONSTANTS.STEEL_GRADE[steelGrade].E; // MPa = N/mm^2
    const I = section.Ix || 0; // mm^4
    if (!I || !E || !L_mm) return 0;

    if (loadType === 'uniform'){
      // totalLoad_kN is the total vertical load on the span (kN)
      // w in kN/m; 1 kN/m = 1 N/mm numerically
      const w_kN_per_m = totalLoad_kN / (L_mm/1000);
      const w_N_per_mm = w_kN_per_m; // since 1 kN/m = 1 N/mm
      const delta_mm = (5 * w_N_per_mm * Math.pow(L_mm,4)) / (384 * E * I);
      return Math.abs(delta_mm);
    } else { // point load at midspan
      const P_N = (totalLoad_kN || 0) * 1000; // kN -> N
      const delta_mm = (P_N * Math.pow(L_mm,3)) / (48 * E * I);
      return Math.abs(delta_mm);
    }
}

  // Axial compression capacity (very simplified): min(yield, Euler) with kL
  function axialCompressionCapacity(section, steelGrade, kL_mm){
    const fy = CONSTANTS.STEEL_GRADE[steelGrade].fy;
    // Approximate area from mass; 7850 kg/m^3 steel density -> area mm^2
    const A = (section.mass||0) * 1e6 / 7850 / 1000; // rough mm^2
    if (!A) return 0;
    const Py_yield = fy * A / 1000; // kN

    const E = CONSTANTS.STEEL_GRADE[steelGrade].E;
    const Iy = section.Iy || section.Ix*0.35 || 0;
    const r = (Iy>0 && A>0) ? Math.sqrt(Iy / A) : 15; // mm
    const slender = (kL_mm||0) / Math.max(r,1);
    if (!kL_mm || kL_mm<=0 || !Iy) return CONSTANTS.PHI.AXIAL * Py_yield;

    // Euler (pin-pin) Pcr = pi^2 E I / (kL)^2
    const Pcr = Math.PI*Math.PI * E * Iy / ( (kL_mm||1)*(kL_mm||1) ) / 1000; // kN
    const Py = Math.min(Py_yield, Pcr);
    return CONSTANTS.PHI.AXIAL * Py;
  }

  // Demand helpers
  function simpleMaxMoment_kNm(totalShear_kN, L_mm, loadType){
    // Under our inputs: totalShear_kN = total vertical load on span
    if (loadType==='uniform'){
      return totalShear_kN * (L_mm/1000) / 8;
    } else {
      return totalShear_kN * (L_mm/1000) / 4;
    }
  }

  // ===============================
  // DOM wiring (steps)
  // ===============================
  const stepEls = [null,
    document.getElementById('step1'),
    document.getElementById('step2'),
    document.getElementById('step3'),
    document.getElementById('step4'),
    document.getElementById('step5')
  ];
  const circleEls = [null,
    document.getElementById('s1'),
    document.getElementById('s2'),
    document.getElementById('s3'),
    document.getElementById('s4'),
    document.getElementById('s5')
  ];

  function updateSteps(){
    stepEls.forEach((el,i)=>{ if (!el || i===0) return; el.classList.toggle('hidden', i!==currentStep); });
    circleEls.forEach((c,i)=>{
      if (!c || i===0) return;
      c.classList.toggle('active', i===currentStep);
      c.classList.toggle('done', i<currentStep);
    });
  }

  // Populate single section list
  function populateSections(){
    const typeSel = document.getElementById('section-type');
    const sizeSel = document.getElementById('section-size');
    sizeSel.innerHTML = "";
    const t = typeSel.value;
    (sectionDatabase[t]||[]).forEach(sec=>{
      const opt = document.createElement('option');
      opt.value = sec.size; opt.textContent = `${sec.size} (${sec.mass} kg/m)`;
      sizeSel.appendChild(opt);
    });
    updateSectionDetails();
  }
  function updateSectionDetails(){
    const t = document.getElementById('section-type').value;
    const s = document.getElementById('section-size').value;
    const sec = findSection(t, s);
    const div = document.getElementById('section-details');
    if (!sec){ div.innerHTML = "<em>Select a section.</em>"; return; }
    div.innerHTML = `
      <strong>${sec.size}</strong>
      <div>Mass: ${sec.mass} kg/m</div>
      <div>Dims: ${formatDims(sec)}</div>
      <div>Ix: ${(sec.Ix||0).toExponential(2)} mm‚Å¥, Iy: ${(sec.Iy||0).toExponential(2)} mm‚Å¥</div>
      <div>Zx: ${(sec.Zx||0).toExponential(2)} mm¬≥, Zy: ${(sec.Zy||0).toExponential(2)} mm¬≥</div>
    `;
  }

  // Build multi-member row
  function buildMemberRow(m){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${m.id}" data-field="id" style="width:90px"/></td>
      <td>
        <select data-field="memberType">
          <option value="beam" ${m.memberType==='beam'?'selected':''}>Beam</option>
          <option value="column" ${m.memberType==='column'?'selected':''}>Column</option>
        </select>
      </td>
      <td>
        <select data-field="sectionType">
          <option value="ub" ${m.sectionType==='ub'?'selected':''}>UB</option>
          <option value="uc" ${m.sectionType==='uc'?'selected':''}>UC</option>
          <option value="rhs" ${m.sectionType==='rhs'?'selected':''}>RHS</option>
        </select>
      </td>
      <td><select data-field="sectionSize"></select></td>
      <td><input type="number" value="${m.length}" data-field="length" style="width:110px"/></td>
      <td><input type="number" value="${m.index}" data-field="index" style="width:80px"/></td>
      <td><input type="number" value="${m.Lb||0}" data-field="Lb" style="width:110px"/></td>
      <td><input type="number" value="${m.kL||0}" data-field="kL" style="width:110px"/></td>
      <td><input type="text" value="${m.endA||''}" data-field="endA" style="width:140px" placeholder="e.g., 2-M16, 6mm FS"/></td>
      <td><input type="text" value="${m.endB||''}" data-field="endB" style="width:140px" placeholder="e.g., 2-M16, 6mm FS"/></td>
      <td><button class="btn danger tight" data-action="remove">Remove</button></td>
    `;
    const typeSel = tr.querySelector('select[data-field="sectionType"]');
    const sizeSel = tr.querySelector('select[data-field="sectionSize"]');
    function populateSize(){
      sizeSel.innerHTML = "";
      (sectionDatabase[typeSel.value]||[]).forEach(sec=>{
        const opt = document.createElement('option');
        opt.value = sec.size; opt.textContent = `${sec.size}`;
        if (sec.size === m.sectionSize) opt.selected = true;
        sizeSel.appendChild(opt);
      });
      m.sectionSize = sizeSel.value;
      m.section = findSection(m.sectionType, m.sectionSize);
    }
    populateSize();

    tr.querySelectorAll('input,select').forEach(inp=>{
      inp.addEventListener('change', (e)=>{
        const f = e.target.getAttribute('data-field');
        let val = e.target.value;
        if (['length','index','Lb','kL'].includes(f)){ val = safeNum(val, 0); }
        m[f] = val;
        if (f==='sectionType'){ populateSize(); }
        if (f==='sectionSize'){ m.section = findSection(m.sectionType, m.sectionSize); }
      });
    });
    tr.querySelector('[data-action="remove"]').addEventListener('click', ()=>{
      multi.members = multi.members.filter(x => x!==m);
      renderMemberTable();
    });
    return tr;
  }
  function renderMemberTable(){
    const tbody = document.getElementById('member-tbody');
    tbody.innerHTML = "";
    multi.members.forEach(m => {
      if (!m.section) m.section = findSection(m.sectionType, m.sectionSize);
      tbody.appendChild(buildMemberRow(m));
    });
    // Rebuild per-member instruction editors if visible
    buildPerMemberInstructionEditors();
  }

  // ===============================
  // Summary calculations UI
  // ===============================
  function createCheckCell(title, cap, dem){
    const util = dem/(cap||1);
    return `<tr><td>${title}</td><td>${fmt(cap)}</td><td>${fmt(dem)}</td><td><span class="status ${getStatusClass(util)}">${(util*100).toFixed(1)}%</span></td></tr>`;
  }

  function computeSingleSummary(){
    const { sectionData } = single;
    const { loadType, deadLoad, liveLoad } = single.loadingData;
    const totalShear = (deadLoad||0) + (liveLoad||0);
    const L = sectionData.length;
    const Lb = sectionData.Lb || 0;
    const kL = sectionData.kL || 0;
    const axial = single.axial||0;

    const Mcap = momentCapacityWithLTB(sectionData.section, sectionData.steelGrade, Lb);
    const Vcap = shearCapacity(sectionData.section, sectionData.steelGrade);
    const Ncap = axialCompressionCapacity(sectionData.section, sectionData.steelGrade, kL);

    const Mdem = simpleMaxMoment_kNm(totalShear, L, loadType);
    const defl = deflectionSimplySupported(sectionData.section, sectionData.steelGrade, L, totalShear, loadType);
    const allow = L/300;

    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <h4>Single Member ‚Äî ${sectionData.sectionSize} (Grade ${sectionData.steelGrade})</h4>
      <table class="result-table">
        <thead><tr><th>Check</th><th>Capacity</th><th>Demand</th><th>Utilization</th></tr></thead>
        <tbody>
          ${createCheckCell('Bending (kNm)', Mcap, Mdem)}
          ${createCheckCell('Shear (kN)', Vcap, totalShear)}
          ${createCheckCell('Axial Comp. (kN)', Ncap, Math.max(0, axial))}
          ${createCheckCell('Deflection (mm; allow L/300)', allow, defl)}
        </tbody>
      </table>
      <table class="result-table" style="margin-top:8px;"><tbody>
        <tr><td>Section</td><td>${sectionData.sectionSize}</td></tr>
        <tr><td>Mass</td><td>${sectionData.section.mass} kg/m</td></tr>
        <tr><td>Grade</td><td>Grade ${sectionData.steelGrade}</td></tr>
        <tr><td>Dimensions</td><td>${formatDims(sectionData.section)}</td></tr>
      </tbody></table>
    `;
    return wrap;
  }

  function computeMultiSummary(){
    const wrap = document.createElement('div');
    const grade = multi.steelGrade;
    const { loadType, dead, live, axial } = multi.loading;
    const total = (dead||0) + (live||0);

    wrap.innerHTML = `<h4>${multi.members.length} Members (Grade ${grade})</h4>`;
    const table = document.createElement('table');
    table.className = 'result-table';
    table.innerHTML = '<thead><tr><th>ID</th><th>Section</th><th>L (mm)</th><th>Lb</th><th>kL</th><th>M cap</th><th>M dem</th><th>Util</th><th>V cap</th><th>V dem</th><th>Util</th><th>N cap</th><th>N dem</th><th>Util</th><th>Defl</th><th>Util</th></tr></thead>';
    const tbody = document.createElement('tbody');

    multi.members.forEach(m => {
      const L = m.length;
      const sec = m.section || findSection(m.sectionType, m.sectionSize);
      const Mcap = momentCapacityWithLTB(sec, grade, m.Lb||0);
      const Vcap = shearCapacity(sec, grade);
      const Ncap = axialCompressionCapacity(sec, grade, m.kL||0);
      const Mdem = simpleMaxMoment_kNm(total, L, loadType);
      const defl = deflectionSimplySupported(sec, grade, L, total, loadType);
      const utilM = Mdem/(Mcap||1), utilV = total/(Vcap||1), utilN = Math.max(0, axial)/(Ncap||1), utilD = defl/((L/300)||1);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${m.id}</td>
        <td>${m.sectionSize}</td>
        <td>${L.toFixed(0)}</td>
        <td>${m.Lb||0}</td>
        <td>${m.kL||0}</td>
        <td>${fmt(Mcap)}</td>
        <td>${fmt(Mdem)}</td>
        <td><span class="status ${getStatusClass(utilM)}">${(utilM*100).toFixed(1)}%</span></td>
        <td>${fmt(Vcap)}</td>
        <td>${fmt(total)}</td>
        <td><span class="status ${getStatusClass(utilV)}">${(utilV*100).toFixed(1)}%</span></td>
        <td>${fmt(Ncap)}</td>
        <td>${fmt(Math.max(0, axial))}</td>
        <td><span class="status ${getStatusClass(utilN)}">${(utilN*100).toFixed(1)}%</span></td>
        <td>${fmt(defl)}</td>
        <td><span class="status ${getStatusClass(utilD)}">${(utilD*100).toFixed(1)}%</span></td>
      `;
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  // ===============================
  // Instructions UI (Step 5)
  // ===============================
  function buildPerMemberInstructionEditors(){
    const container = document.getElementById('per-member-instr');
    if (!container) return;
    container.innerHTML = "";
    multi.members.forEach((m, idx) => {
      const id = m.id || `M${idx+1}`;
      const val = multi.instructions.perMember[id] || "";
      const block = document.createElement('div');
      block.className = 'card';
      block.innerHTML = `
        <label for="instr-${id}">Member ${id} ‚Äî Procedure</label>
        <textarea id="instr-${id}" data-mid="${id}" placeholder="Step-by-step for ${id}...">${val}</textarea>
      `;
      container.appendChild(block);
    });
    container.querySelectorAll('textarea[data-mid]').forEach(t=>{
      t.addEventListener('input', e=>{
        const mid = e.target.getAttribute('data-mid');
        multi.instructions.perMember[mid] = e.target.value;
      });
    });
  }

  // ===============================
  // Drawing (Shop Drawing)
  // ===============================
  function drawArrow(ctx, x1,y1,x2,y2){
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    const ang = Math.atan2(y2-y1, x2-x1), s=7;
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - s*Math.cos(ang - Math.PI/6), y2 - s*Math.sin(ang - Math.PI/6));
    ctx.lineTo(x2 - s*Math.cos(ang + Math.PI/6), y2 - s*Math.sin(ang + Math.PI/6));
    ctx.closePath(); ctx.fill();
  }
  function drawDimension(ctx, x1,y1,x2,y2, text){
    ctx.save();
    ctx.strokeStyle = '#000'; ctx.fillStyle = '#000';
    // extension lines
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x1,y1-8); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x2,y2); ctx.lineTo(x2,y2-8); ctx.stroke();
    // dim line with arrows both ways
    drawArrow(ctx, x1, y1-8, x2, y2-8);
    drawArrow(ctx, x2, y2-8, x1, y1-8);
    // text
    ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
    ctx.font = '12px sans-serif';
    ctx.fillText(text, (x1+x2)/2, y1-10);
    ctx.restore();
  }
  function drawLeaderText(ctx, x1,y1, x2,y2, text){
    ctx.save();
    ctx.strokeStyle = '#000'; ctx.fillStyle = '#000';
    drawArrow(ctx, x1,y1, x2,y2);
    ctx.font = '12px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(text, x2+6, y2);
    ctx.restore();
  }

  function drawTitleBlock(ctx, canvas){
    const W = canvas.width, H = canvas.height;
    const tbW = 300, tbH = 120, margin = 20;
    const tbx = W - margin - tbW, tby = H - margin - tbH;
    ctx.save();
    ctx.strokeStyle = '#000'; ctx.fillStyle = '#000'; ctx.lineWidth = 1;
    ctx.strokeRect(tbx, tby, tbW, tbH);
    ctx.font = '12px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top';
    const today = titleBlock.date || new Date().toISOString().slice(0,10);
    const rows = [
      `Project: ${titleBlock.project||''}`,
      `Title: ${titleBlock.title||''}`,
      `Drawing No.: ${titleBlock.number||''}  Rev: ${titleBlock.rev||''}`,
      `Drawn: ${titleBlock.drawn||''}  Checked: ${titleBlock.checked||''}`,
      `Date: ${today}  Scale: ${titleBlock.scale||'Auto-fit'}`
    ];
    rows.forEach((r,i)=> ctx.fillText(r, tbx+10, tby+10 + 18*i) );
    ctx.restore();
  }

  function drawShopDrawing(){
    const canvas = document.getElementById('shop-drawing');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#000'; ctx.strokeStyle = '#000';

    const showCall = document.getElementById('toggle-callouts').checked;
    const showDims = document.getElementById('toggle-dims').checked;
    const showElev = document.getElementById('toggle-elev').checked;
    const showInstr = document.getElementById('toggle-instructions').checked;

    const W = canvas.width, H = canvas.height;
    const margin = 50;
    const planArea = { x: margin, y: margin, w: W-2*margin, h: (H-3*margin)/2 };
    const elevArea = { x: margin, y: planArea.y + planArea.h + margin, w: W-2*margin, h: (H-3*margin)/2 };

    // Titles
    ctx.font = '16px sans-serif'; ctx.textAlign = 'left'; ctx.textBaseline='alphabetic';
    ctx.fillText('PLAN', planArea.x, planArea.y - 12);
    if (showElev) ctx.fillText('ELEVATION', elevArea.x, elevArea.y - 12);

    // If no members
    if (multi.members.length === 0){
      ctx.font = '14px sans-serif';
      ctx.fillText('No members. Add members in Step 2.', planArea.x, planArea.y+20);
      drawTitleBlock(ctx, canvas);
      return;
    }

    const spacing = multi.spacing;
    const indices = multi.members.map(m => m.index).sort((a,b)=>a-b);
    const minIdx = indices[0], maxIdx = indices[indices.length-1];
    const overallLength = Math.max(0, (maxIdx - minIdx) * spacing);

    const usableW = planArea.w - 150;
    const planScale = (overallLength>0) ? (usableW / overallLength) : 1;

    // PLAN: baseline
    const baseY = planArea.y + planArea.h/2;
    ctx.lineWidth = 2; ctx.beginPath();
    ctx.moveTo(planArea.x+60, baseY); ctx.lineTo(planArea.x+60 + Math.max(overallLength*planScale, 200), baseY);
    ctx.stroke();

    // Draw members as glyphs
    const glyphW = 90, glyphH = 16;
    ctx.font = '12px sans-serif';
    multi.members.forEach((m,i) => {
      const pos = (m.index - minIdx) * spacing;
      const x = planArea.x + 60 + pos*planScale - glyphW/2;
      const y = baseY - glyphH/2;
      // glyph
      ctx.fillStyle = '#888'; ctx.fillRect(x, y, glyphW, glyphH);
      ctx.strokeStyle = '#000'; ctx.strokeRect(x, y, glyphW, glyphH);
      ctx.fillStyle = '#000'; ctx.textAlign='center';
      ctx.fillText(m.id || '', x + glyphW/2, y - 6);

      if (showCall){
        // Leader from left end (A) up-left
        const ax = x, ay = y + glyphH/2;
        drawLeaderText(ctx, ax, ay, ax-40, ay-30, `A: ${m.endA||'-'}`);
        // Leader from right end (B) up-right
        const bx = x+glyphW, by = y + glyphH/2;
        drawLeaderText(ctx, bx, by, bx+40, by-30, `B: ${m.endB||'-'}`);
      }
    });

    // Dimensions
    if (showDims){
      drawDimension(ctx, planArea.x+60, baseY+40, planArea.x+60 + Math.max(overallLength*planScale, 200), baseY+40, `${overallLength.toFixed(0)} mm`);
      const sorted = multi.members.slice().sort((a,b)=>a.index-b.index);
      for (let i=1;i<sorted.length;i++){
        const prev = sorted[i-1], cur = sorted[i];
        const x1 = planArea.x + 60 + ((prev.index - minIdx) * spacing)*planScale;
        const x2 = planArea.x + 60 + ((cur.index - minIdx) * spacing)*planScale;
        drawDimension(ctx, x1, baseY+70, x2, baseY+70, `${((cur.index - prev.index)*spacing).toFixed(0)} mm`);
      }
    }

    // ELEVATION
    if (showElev){
      const maxLen = Math.max(...multi.members.map(m=>m.length));
      const elevScale = (elevArea.h - 80) / Math.max(maxLen,1);
      const elevBaseY = elevArea.y + elevArea.h - 30;
      const elevStartX = elevArea.x + 60;

      // ground/reference line
      ctx.beginPath(); ctx.moveTo(elevStartX, elevBaseY); ctx.lineTo(elevStartX + Math.max(overallLength*planScale, 200), elevBaseY); ctx.stroke();

      multi.members.forEach(m=>{
        const pos = (m.index - minIdx) * spacing;
        const x = elevStartX + pos*planScale;
        const h = m.length * elevScale;
        ctx.beginPath(); ctx.moveTo(x, elevBaseY); ctx.lineTo(x, elevBaseY - h); ctx.stroke();
        ctx.textAlign='center';
        ctx.fillText(m.id||'', x, elevBaseY - h - 6);

        if (showDims){
          // vertical dim for member length
          const dx = 20;
          ctx.beginPath(); ctx.moveTo(x+dx, elevBaseY); ctx.lineTo(x+dx, elevBaseY - h); ctx.stroke();
          drawArrow(ctx, x+dx, elevBaseY, x+dx, elevBaseY - h);
          drawArrow(ctx, x+dx, elevBaseY - h, x+dx, elevBaseY);
          ctx.textAlign='left'; ctx.textBaseline='middle';
          ctx.fillText(`${m.length.toFixed(0)} mm`, x+dx+6, elevBaseY - h/2);
        }
      });
    }

    // Instructions overlay (right panel)
    if (showInstr){
      const panelW = 340;
      const px = W - panelW - 20, py = 20, ph = H - 160;
      ctx.save();
      ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000';
      ctx.fillRect(px, py, panelW, ph); ctx.strokeRect(px, py, panelW, ph);
      ctx.fillStyle = '#000'; ctx.font = '14px sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top';
      ctx.fillText('Assembly Instructions', px+10, py+10);
      ctx.font = '12px sans-serif';

      let y = py+32;
      if (multi.instructions.general){
        const gen = `General:\n${multi.instructions.general}`;
        y = drawWrappedText(ctx, gen, px+10, y, panelW-20, 16);
        y += 8;
      }
      const sorted = multi.members.slice().sort((a,b)=>a.index-b.index);
      sorted.forEach((m,i)=>{
        const txt = `${i+1}) ${m.id}: ${multi.instructions.perMember[m.id]||'-'}`;
        y = drawWrappedText(ctx, txt, px+10, y, panelW-20, 16);
        y += 6;
      });
      ctx.restore();
    }

    // Title block
    drawTitleBlock(ctx, canvas);
  }

  function drawWrappedText(ctx, text, x, y, maxW, lineH){
    const lines = (text||'').split('\n');
    lines.forEach(line=>{
      const words = line.split(' ');
      let current = '';
      words.forEach(w=>{
        const test = current ? current + ' ' + w : w;
        if (ctx.measureText(test).width > maxW){
          ctx.fillText(current, x, y); y += lineH; current = w;
        } else {
          current = test;
        }
      });
      if (current){ ctx.fillText(current, x, y); y += lineH; }
    });
    return y;
  }

  // ===============================
  // Event wiring
  // ===============================
  document.getElementById('theme-toggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark-mode');
    const btn = document.getElementById('theme-toggle');
    btn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  });

  // Step 1
  document.getElementById('design-type').addEventListener('change', (e)=>{
    designType = e.target.value || null;
    document.getElementById('next1').disabled = !designType;
  });
  document.getElementById('next1').addEventListener('click', ()=>{
    if (!designType) return;
    currentStep = 2;
    document.getElementById('single-ui').classList.toggle('hidden', designType!=='single');
    document.getElementById('multi-ui').classList.toggle('hidden', designType!=='multi');
    document.getElementById('conn-ui').classList.toggle('hidden', designType!=='connection');
    updateSteps(); showNotification('Proceed to member specs');
  });

  // Step 2
  document.getElementById('section-type').addEventListener('change', populateSections);
  document.getElementById('section-size').addEventListener('change', updateSectionDetails);

  // Connection UI wiring
  function populateConnSections(){
    const typeSel = document.getElementById('conn-section-type');
    const sizeSel = document.getElementById('conn-section-size');
    sizeSel.innerHTML = '';
    (sectionDatabase[typeSel.value]||[]).forEach(sec=>{
      const opt = document.createElement('option');
      opt.value = sec.size; opt.textContent = `${sec.size}`;
      sizeSel.appendChild(opt);
    });
    conn.member.sectionType = typeSel.value;
    conn.member.sectionSize = sizeSel.value;
    conn.member.section = findSection(conn.member.sectionType, conn.member.sectionSize);
  }
  document.getElementById('conn-section-type').addEventListener('change', populateConnSections);
  document.getElementById('conn-section-size').addEventListener('change', ()=>{
    conn.member.sectionSize = document.getElementById('conn-section-size').value;
    conn.member.section = findSection(conn.member.sectionType, conn.member.sectionSize);
  });
  document.getElementById('conn-steel-grade').addEventListener('change', (e)=>{ conn.member.steelGrade = e.target.value; });
  document.getElementById('conn-bolt-dia').addEventListener('change', (e)=>{ conn.bolts.dia = safeNum(e.target.value,16); });
  document.getElementById('conn-bolt-class').addEventListener('change', (e)=>{ conn.bolts.cls = e.target.value; });
  document.getElementById('conn-rows').addEventListener('input', (e)=>{ conn.bolts.rows = safeNum(e.target.value,2); });
  document.getElementById('conn-pitch').addEventListener('input', (e)=>{ conn.geom.pitch = safeNum(e.target.value,70); });
  document.getElementById('conn-e1').addEventListener('input', (e)=>{ conn.geom.e1 = safeNum(e.target.value,35); });
  document.getElementById('conn-e2').addEventListener('input', (e)=>{ conn.geom.e2 = safeNum(e.target.value,35); });
  document.getElementById('conn-plate-t').addEventListener('input', (e)=>{ conn.geom.t = safeNum(e.target.value,10); });
  document.getElementById('conn-weld-a').addEventListener('input', (e)=>{ conn.weld.a = safeNum(e.target.value,6); });
  document.getElementById('conn-V').addEventListener('input', (e)=>{ conn.loads.V = safeNum(e.target.value,0); });
  document.getElementById('conn-N').addEventListener('input', (e)=>{ conn.loads.N = safeNum(e.target.value,0); });
  document.getElementById('conn-M').addEventListener('input', (e)=>{ conn.loads.M = safeNum(e.target.value,0); });
  // Initial populate for connection section sizes
  populateConnSections();

  document.getElementById('add-member').addEventListener('click', ()=>{
    const nextIdx = multi.members.length ? (Math.max(...multi.members.map(m=>m.index))+1) : 0;
    const m = {
      id: 'M' + (multi.members.length+1),
      memberType: 'beam',
      sectionType: 'ub',
      sectionSize: sectionDatabase.ub[0].size,
      length: 4000,
      index: nextIdx,
      Lb: 0,
      kL: 0,
      endA: '',
      endB: ''
    };
    m.section = findSection(m.sectionType, m.sectionSize);
    multi.members.push(m);
    renderMemberTable();
  });
  document.getElementById('clear-members').addEventListener('click', ()=>{ multi.members = []; renderMemberTable(); });
  document.getElementById('member-spacing').addEventListener('change', (e)=>{ multi.spacing = safeNum(e.target.value, multi.spacing); });
  document.getElementById('row-origin').addEventListener('change', (e)=>{ multi.origin = safeNum(e.target.value, 0); });
  document.getElementById('multi-steel-grade').addEventListener('change', (e)=>{ multi.steelGrade = e.target.value; });

  document.getElementById('prev2').addEventListener('click', ()=>{ currentStep=1; updateSteps(); });
  document.getElementById('next2').addEventListener('click', ()=>{
    if (designType === 'single'){
      const memberType = document.getElementById('member-type').value;
      const sectionType = document.getElementById('section-type').value;
      const sectionSize = document.getElementById('section-size').value;
      const length = safeNum(document.getElementById('member-length').value, 0);
      const steelGrade = document.getElementById('steel-grade').value;
      const sec = findSection(sectionType, sectionSize);
      if (!sec){ showNotification('Pick a section size'); return; }
      single.sectionData = { memberType, sectionType, sectionSize, length, steelGrade, section: sec, Lb:0, kL:0 };
    } else if (designType === 'multi') {
      if (multi.members.length===0){ showNotification('Add at least one member'); return; }
      for (const m of multi.members){
        m.section = findSection(m.sectionType, m.sectionSize);
        if (!m.section){ showNotification('Section missing for ' + (m.id||'?')); return; }
      }
    } else if (designType === 'connection') {
      // Ensure member section is selected
      populateConnSections();
      if (!conn.member.section){ showNotification('Pick a member section'); return; }
    }
    // toggle loads UI
    document.getElementById('single-loads').classList.toggle('hidden', designType!=='single');
    document.getElementById('multi-loads').classList.toggle('hidden', designType!=='multi');
    document.getElementById('conn-loads').classList.toggle('hidden', designType!=='connection');
    currentStep = 3; updateSteps();
  });

  // Step 3
  document.getElementById('prev3').addEventListener('click', ()=>{ currentStep=2; updateSteps(); });
  document.getElementById('next3').addEventListener('click', ()=>{
    if (designType==='single'){
      const dead = safeNum(document.getElementById('dead-load').value,0);
      const live = safeNum(document.getElementById('live-load').value,0);
      const loadType = document.getElementById('load-type').value;
      single.loadingData = { deadLoad: dead, liveLoad: live, loadType };
      single.axial = safeNum(document.getElementById('axial-load').value,0);
    } else if (designType==='multi'){
      const dead = safeNum(document.getElementById('multi-dead-load').value,0);
      const live = safeNum(document.getElementById('multi-live-load').value,0);
      const loadType = document.getElementById('multi-load-type').value;
      const axial = safeNum(document.getElementById('multi-axial-load').value,0);
      multi.loading = { loadType, dead, live, axial };
    } else if (designType==='connection'){
      conn.loads.V = safeNum(document.getElementById('conn-V').value,0);
      conn.loads.N = safeNum(document.getElementById('conn-N').value,0);
      conn.loads.M = safeNum(document.getElementById('conn-M').value,0);
    }
    currentStep = 4; updateSteps();
    computeResults();
  });

  // Step 4
  document.getElementById('prev4').addEventListener('click', ()=>{ currentStep=3; updateSteps(); });
  document.getElementById('result-view-selector').addEventListener('change', ()=>{
    switchResultView();
    if (!document.getElementById('result-drawing').classList.contains('hidden')) drawShopDrawing();
  });
  document.getElementById('download').addEventListener('click', ()=>{
    const payload = {
      designType, single, multi, conn, titleBlock
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'design_data.json'; a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById('download-png').addEventListener('click', ()=>{
    const c = document.getElementById('shop-drawing');
    const a = document.createElement('a');
    a.href = c.toDataURL('image/png');
    a.download = 'shop_drawing.png';
    a.click();
  });
  document.getElementById('toggle-callouts').addEventListener('change', drawShopDrawing);
  document.getElementById('toggle-dims').addEventListener('change', drawShopDrawing);
  document.getElementById('toggle-elev').addEventListener('change', drawShopDrawing);
  document.getElementById('toggle-instructions').addEventListener('change', drawShopDrawing);

  // Title block editor
  function readTitleBlockInputs(){
    titleBlock.project = document.getElementById('tb-project').value || "";
    titleBlock.title   = document.getElementById('tb-title').value || "";
    titleBlock.number  = document.getElementById('tb-dwgno').value || "";
    titleBlock.rev     = document.getElementById('tb-rev').value || "";
    titleBlock.drawn   = document.getElementById('tb-drawn').value || "";
    titleBlock.checked = document.getElementById('tb-checked').value || "";
    titleBlock.date    = document.getElementById('tb-date').value || "";
    titleBlock.scale   = document.getElementById('tb-scale').value || "Auto-fit";
  }
  document.getElementById('redraw').addEventListener('click', ()=>{ readTitleBlockInputs(); drawShopDrawing(); });

  // Step 5 (Assembly)
  document.getElementById('prev5').addEventListener('click', ()=>{ currentStep=4; updateSteps(); });
  document.getElementById('finish').addEventListener('click', ()=>{
    if (designType==='single'){
      single.instructions = document.getElementById('single-instructions').value || "";
    } else {
      multi.instructions.general = document.getElementById('general-instructions').value || "";
      // perMember already live-updated
    }
    showNotification('Instructions saved. See drawing overlay toggle.');
    currentStep=4; updateSteps(); document.getElementById('result-view-selector').value='drawing'; switchResultView(); drawShopDrawing();
  });
  document.getElementById('download-instr').addEventListener('click', ()=>{
    let txt = '';
    if (designType==='single'){
      txt += `Single Member Instructions\n\n${single.instructions||''}\n`;
    } else {
      txt += `General Procedure / Notes\n\n${multi.instructions.general||''}\n\n`;
      const sorted = multi.members.slice().sort((a,b)=>a.index-b.index);
      sorted.forEach((m,i)=>{
        txt += `${i+1}) ${m.id}: ${multi.instructions.perMember[m.id]||'-'}\n`;
      });
    }
    const blob = new Blob([txt], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'assembly_instructions.txt'; a.click();
    URL.revokeObjectURL(a.href);
  });

  // Helpers
  function switchResultView(){
    const v = document.getElementById('result-view-selector').value;
    document.getElementById('result-summary').classList.toggle('hidden', v!=='summary');
    document.getElementById('result-detailed').classList.toggle('hidden', v!=='detailed');
    document.getElementById('result-drawing').classList.toggle('hidden', v!=='drawing');
  }

  function computeResults(){
    const summaryContainer = document.getElementById('summary-container');
    summaryContainer.innerHTML = "";
    if (designType==='single'){
      summaryContainer.appendChild(computeSingleSummary());
      document.getElementById('result-view-selector').value = 'summary';
      switchResultView();
      // (Optional) draw detailed single
      const s = single.sectionData; const l = single.loadingData;
      if (s && l){
        const canvas = document.getElementById('detailed-analysis');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // very simple beam, loads omitted for brevity
        ctx.fillStyle='#888'; const margin=40, spanY=canvas.height/3, spanPx=canvas.width-2*margin, h=18;
        ctx.fillRect(margin, spanY-h/2, spanPx, h);
      }
    } else if (designType==='multi') {
      summaryContainer.appendChild(computeMultiSummary());
      document.getElementById('result-view-selector').value = 'drawing';
      switchResultView();
      readTitleBlockInputs();
      drawShopDrawing();
    } else if (designType==='connection') {
      const res = designShearPlate(conn);
      const wrap = document.createElement('div');
      const hdr = `<div class=\"muted\">Standards set: AS4100:${AS4100.version} (prototype factors)</div>`;
      let rows = '';
      res.checks.forEach(c => { rows += `<tr><td>${c.name}</td><td>${c.clauseRef}</td><td>${fmt(c.capacity,'kN')}</td><td>${fmt(c.demand,'kN')}</td><td><span class=\\\"status ${getStatusClass(c.utilisation)}\\\">${(c.utilisation*100).toFixed(1)}%</span></td></tr>`; });
      wrap.innerHTML = `
        <h4>Shear Plate ‚Äî ${conn.member.sectionSize} (Grade ${conn.member.steelGrade}), ${conn.bolts.rows}√ó1 M${conn.bolts.dia} class ${conn.bolts.cls}</h4>
        ${hdr}
        <table class=\"result-table\">
          <thead><tr><th>Check</th><th>Clause</th><th>Capacity</th><th>Demand</th><th>Utilisation</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <table class=\"result-table\" style=\"margin-top:8px;\"><tbody>
          <tr><td>Governing</td><td>${res.governingCheck}</td></tr>
          <tr><td>Status</td><td>${res.ok? '<span class=\\\"status status-ok\\\">OK</span>':'<span class=\\\"status status-bad\\\">NG</span>'}</td></tr>
          <tr><td>BOM</td><td>${res.bom.bolts}√óM${conn.bolts.dia}, Plate t=${conn.geom.t} mm, Weld a=${conn.weld.a} mm</td></tr>
        </tbody></table>
        <div class=\"muted\">Notes: ${res.notes.join(' ‚Ä¢ ')}</div>
      `;
      summaryContainer.appendChild(wrap);
      document.getElementById('result-view-selector').value = 'summary';
      switchResultView();
    }
    showNotification('Design calculation complete');
  }

  // ===============================
  // Init
  // ===============================
  (function init(){
    updateSteps();
    // Step 1
    document.getElementById('design-type').value = '';
    document.getElementById('next1').disabled = true;
    // Single defaults
    (function initSingle(){
      const typeSel = document.getElementById('section-type');
      typeSel.value = 'ub';
      populateSections();
    })();
    // Title block defaults
    document.getElementById('tb-project').value = titleBlock.project;
    document.getElementById('tb-title').value   = titleBlock.title;
    document.getElementById('tb-dwgno').value   = titleBlock.number;
    document.getElementById('tb-rev').value     = titleBlock.rev;
    document.getElementById('tb-drawn').value   = titleBlock.drawn;
    document.getElementById('tb-checked').value = titleBlock.checked;
    document.getElementById('tb-date').value    = titleBlock.date;
    document.getElementById('tb-scale').value   = titleBlock.scale;

    // Step 5 mode toggles (will be shown when entering step 5)
    const goStep5 = ()=>{
      currentStep = 5; updateSteps();
      document.getElementById('single-instr').classList.toggle('hidden', designType!=='single');
      document.getElementById('multi-instr').classList.toggle('hidden', designType!=='multi');
      if (designType==='multi'){ buildPerMemberInstructionEditors(); }
    };
    // Add keyboard shortcut: when on step 4, press "i" to jump to instructions
    document.addEventListener('keydown', (e)=>{
      if (e.key.toLowerCase()==='i' && currentStep===4){ goStep5(); }
    });

    // Also add a small button into Step 4 title area (UX sugar)
    const step4 = document.getElementById('step4');
    const btn = document.createElement('button');
    btn.textContent = 'Next: Assembly Instructions';
    btn.className = 'btn secondary';
    btn.style.marginTop = '8px';
    btn.addEventListener('click', goStep5);
    step4.appendChild(btn);
  })();
  </script>
</body>
</html>
